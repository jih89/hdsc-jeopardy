// Dummy data as fallback
const dummyQuestionData = {
    // Kategori 0: Matematika Dasar
    0: {
        0: [ // 10
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        1: [ // 20
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        2: [ // 30
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        3: [ // 40
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        4: [ // 50
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        5: [ // 6
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        6: [ // 70
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        7: [ // 80
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        8: [ // 90
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        9: [ // 100
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ]
    },
    // Kategori 1: Biologi
    1: {
        0: [ // 10
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        1: [ // 20
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        2: [ // 30
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        3: [ // 40
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        4: [ // 50
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        5: [ // 6
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        6: [ // 70
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        7: [ // 80
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        8: [ // 90
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        9: [ // 100
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ]
    },
    // Kategori 2: Kedokteran Gigi Dasar
    2: {
        0: [ // 10
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        1: [ // 20
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        2: [ // 30
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        3: [ // 40
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        4: [ // 50
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        5: [ // 6
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        6: [ // 70
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        7: [ // 80
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        8: [ // 90
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ],
        9: [ // 100
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" },
            { q: "Question Question Question Question Question Question Question", a: "Answer Answer Answer Answer" }
        ]
    }
};

// Initialize questionData with dummy data (will be merged with DB data)
let questionData = JSON.parse(JSON.stringify(dummyQuestionData));

// Fetch questions from database API
async function fetchQuestionsFromDB() {
    try {
        const response = await fetch('/api/questions');
        if (response.ok) {
            const dbQuestions = await response.json();
            // Merge DB questions with dummy data (DB takes priority)
            if (dbQuestions && Object.keys(dbQuestions).length > 0) {
                // Deep merge: DB questions override dummy data
                for (const catId in dbQuestions) {
                    if (questionData[catId]) {
                        // Merge category data
                        for (const pointValue in dbQuestions[catId]) {
                            if (dbQuestions[catId][pointValue] && dbQuestions[catId][pointValue].length > 0) {
                                // Only replace if DB has actual questions
                                const hasValidQuestions = dbQuestions[catId][pointValue].some(q => q.q && q.q.trim() !== '');
                                if (hasValidQuestions) {
                                    questionData[catId][pointValue] = dbQuestions[catId][pointValue];
                                }
                            }
                        }
                    } else {
                        questionData[catId] = dbQuestions[catId];
                    }
                }
                console.log('Questions loaded from database');
            } else {
                console.log('No questions in database, using dummy data');
            }
        }
    } catch (error) {
        console.error('Failed to fetch questions from DB:', error);
        console.log('Using dummy data as fallback');
    }
}


// track grid/question state and the currently open cell
const gridState = {};
let activeCell = null;

const points = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
const categories = ["Matematika Dasar", "Biologi ", "Kedokteran Gigi"];

const board = document.getElementById('board');

const modal = document.getElementById('modal');
const qText = document.getElementById('question');
const aText = document.getElementById('answer');
const attempt = document.getElementById('attempt');

const btnReveal = document.querySelector('.btn-reveal');
const btnCorrect = document.querySelector('.btn-correct');
const btnWrong = document.querySelector('.btn-wrong');
const btnClose = document.querySelector('.btn-close');

// Wire UI buttons to the handler functions
btnReveal.addEventListener('click', window.showAnswer);
btnCorrect.addEventListener('click', window.handleCorrect);
btnWrong.addEventListener('click', window.handleWrong);
btnClose.addEventListener('click', window.closeModal);

function initBoard() {
    for (let i = 0; i < points.length; i++) {
        for (let j = 0; j < categories.length; j++) {
            const point = points[i];
            
            const card = document.createElement('div');
            card.className = 'point-card';
            card.innerText = point;
            card.dataset.cat = j;
            card.dataset.ptIdx = i;
            card.id = `card-${j}-${i}`;

            gridState[`${j}-${i}`] = {
                questionIndex: 0,
                isSolved: false,
                isFailed: false
            };

            card.onclick = () => openQuestion(j, i);
            board.appendChild(card);
        }
    }
}

function openQuestion(catIndex, pointIndex) {
    const key = `${catIndex}-${pointIndex}`;
    const state = gridState[key];
    const card = document.getElementById(`card-${key}`);

    if (state.isSolved || state.isFailed) return;

    activeCell = { key, card, state };

    const qSet = questionData[catIndex] && questionData[catIndex][pointIndex] 
                 ? questionData[catIndex][pointIndex] 
                 : [{q: "Soal belum diisi", a: "-"}];
    
    const currentQ = qSet[state.questionIndex] || qSet[0];

    qText.innerText = currentQ.q;
    aText.innerText = currentQ.a;
    attempt.innerText = `Attempt: ${state.questionIndex + 1}`;

    aText.style.display = 'none';
    btnReveal.style.display = 'inline-block';
    btnCorrect.style.display = 'none';
    btnWrong.style.display = 'none';
    btnClose.style.display = 'inline-block';

    modal.style.display = 'flex';
}

window.showAnswer = function() {
    aText.style.display = 'block';
    btnReveal.style.display = 'none';
    btnCorrect.style.display = 'inline-block';
    btnWrong.style.display = 'inline-block';
    btnClose.style.display = 'none';
};

window.handleCorrect = function() {
    if (!activeCell) return;

    activeCell.state.isSolved = true;
    activeCell.card.classList.add('solved');
    activeCell.card.innerText = '';
    
    closeModal();
};

window.handleWrong = function() {
    if (!activeCell) return;

    activeCell.state.questionIndex++;

    const [catStr, ptStr] = activeCell.key.split('-');
    const catIndex = parseInt(catStr, 10);
    const pointIndex = parseInt(ptStr, 10);

    const qSet = questionData[catIndex] && questionData[catIndex][pointIndex]
                 ? questionData[catIndex][pointIndex]
                 : [{q: "Soal belum diisi", a: "-"}];

    if (activeCell.state.questionIndex >= qSet.length) {
        // no more attempts -> mark as failed and show HANGUS
        activeCell.state.isFailed = true;
        activeCell.card.classList.add('failed');
        activeCell.card.innerText = '';
        closeModal();
        return;
    }
    closeModal();
};

window.closeModal = function() {
    modal.style.display = 'none';
    activeCell = null;
};

// Initialize board after fetching questions from database
(async function init() {
    await fetchQuestionsFromDB();
    initBoard();
})();